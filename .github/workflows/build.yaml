name: Build

on:
  push:
    tags:
      - 'v*'
      - 'mcp-*'
  release:
    types: [published]
  workflow_dispatch:

env:
  GO_VERSION: '1.21'

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get dependencies
        run: |
          curl -OL https://github.com/ystyle/kaf-cli/releases/download/kindlegen/KindleGen_Mac_64bit_v2_9.zip
          curl -OL https://github.com/ystyle/kaf-cli/releases/download/kindlegen/kindlegen_win32_v2_9.zip
          unzip -d darwin KindleGen_Mac_64bit_v2_9.zip
          unzip -d windows kindlegen_win32_v2_9.zip

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git rev-parse --short HEAD)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Using version: ${VERSION}"

      - name: Install rsrc
        run: |
          mkdir -p /home/runner/go_bin
          export GOBIN=/home/runner/go_bin
          go install github.com/akavel/rsrc@latest

      - name: Build CLI
        run: |
          FLAG="-s -w -X main.secret=${{ secrets.API_SECRET }} -X main.measurement=${{ secrets.MEASUREMENT }} -X main.version=${{ env.VERSION }}"
          mkdir -p build
          go mod tidy
          
          GOOS=linux   GOARCH=amd64   go build -ldflags "$FLAG" -o build/linux-amd64/kaf-cli       cmd/cli/main.go
          GOOS=linux   GOARCH=arm64   go build -ldflags "$FLAG" -o build/linux-arm64/kaf-cli       cmd/cli/main.go
          GOOS=linux   GOARCH=loong64 go build -ldflags "$FLAG" -o build/linux-loong64/kaf-cli     cmd/cli/main.go
          GOOS=darwin  GOARCH=amd64   go build -ldflags "$FLAG" -o build/darwin-amd64/kaf-cli      cmd/cli/main.go
          GOOS=darwin  GOARCH=arm64   go build -ldflags "$FLAG" -o build/darwin-arm64/kaf-cli      cmd/cli/main.go
          GOOS=wasip1  GOARCH=wasm    go build -ldflags "$FLAG" -o build/wasm-wasip1/kaf-cli.wasm  cmd/cli/main.go
          /home/runner/go_bin/rsrc -arch amd64 -manifest kaf-cli.exe.manifest -ico ./assets/kaf.ico -o kaf-cli.syso
          GOOS=windows GOARCH=386     go build -ldflags "$FLAG" -o build/windows-386/kaf-cli.exe   cmd/cli/main.go
          GOOS=windows GOARCH=amd64   go build -ldflags "$FLAG" -o build/windows-amd64/kaf-cli.exe cmd/cli/main.go

      - name: Build MCP
        run: |
          FLAG="-s -w -X main.secret=${{ secrets.API_SECRET }} -X main.measurement=${{ secrets.MEASUREMENT }} -X main.version=${{ env.VERSION }}"
          go mod tidy
          
          GOOS=linux   GOARCH=amd64   go build -ldflags "$FLAG" -o build/linux-amd64/kaf-mcp       cmd/mcp/main.go
          GOOS=linux   GOARCH=arm64   go build -ldflags "$FLAG" -o build/linux-arm64/kaf-mcp       cmd/mcp/main.go
          GOOS=linux   GOARCH=loong64 go build -ldflags "$FLAG" -o build/linux-loong64/kaf-mcp     cmd/mcp/main.go
          GOOS=darwin  GOARCH=amd64   go build -ldflags "$FLAG" -o build/darwin-amd64/kaf-mcp      cmd/mcp/main.go
          GOOS=darwin  GOARCH=arm64   go build -ldflags "$FLAG" -o build/darwin-arm64/kaf-mcp      cmd/mcp/main.go
          GOOS=wasip1  GOARCH=wasm    go build -ldflags "$FLAG" -o build/wasm-wasip1/kaf-mcp.wasm  cmd/mcp/main.go
          /home/runner/go_bin/rsrc -arch amd64 -manifest kaf-cli.exe.manifest -ico ./assets/kaf.ico -o kaf-mcp.syso
          GOOS=windows GOARCH=386     go build -ldflags "$FLAG" -o build/windows-386/kaf-mcp.exe   cmd/mcp/main.go
          GOOS=windows GOARCH=amd64   go build -ldflags "$FLAG" -o build/windows-amd64/kaf-mcp.exe cmd/mcp/main.go

      - name: Package CLI
        run: |
          zip -j kaf-cli_${{ env.VERSION }}_windows_amd64.zip build/windows-amd64/kaf-cli.exe windows/kindlegen.exe 注册右键菜单.ps1
          zip -j kaf-cli_${{ env.VERSION }}_windows_386.zip   build/windows-386/kaf-cli.exe windows/kindlegen.exe
          zip -j kaf-cli_${{ env.VERSION }}_darwin_amd64.zip  build/darwin-amd64/kaf-cli darwin/kindlegen
          zip -j kaf-cli_${{ env.VERSION }}_darwin_arm64.zip  build/darwin-arm64/kaf-cli darwin/kindlegen
          zip -j kaf-cli_${{ env.VERSION }}_linux_amd64.zip   build/linux-amd64/kaf-cli
          zip -j kaf-cli_${{ env.VERSION }}_linux_arm64.zip   build/linux-arm64/kaf-cli
          zip -j kaf-cli_${{ env.VERSION }}_linux_loong64.zip build/linux-loong64/kaf-cli
          zip -j kaf-cli_${{ env.VERSION }}_wasm_wasip1.zip   build/wasm-wasip1/kaf-cli.wasm README_wasi.md

      - name: Package MCP
        run: |
          zip -j kaf-mcp_${{ env.VERSION }}_windows_amd64.zip build/windows-amd64/kaf-mcp.exe windows/kindlegen.exe 
          zip -j kaf-mcp_${{ env.VERSION }}_windows_386.zip   build/windows-386/kaf-mcp.exe windows/kindlegen.exe
          zip -j kaf-mcp_${{ env.VERSION }}_darwin_amd64.zip  build/darwin-amd64/kaf-mcp darwin/kindlegen
          zip -j kaf-mcp_${{ env.VERSION }}_darwin_arm64.zip  build/darwin-arm64/kaf-mcp darwin/kindlegen
          zip -j kaf-mcp_${{ env.VERSION }}_linux_amd64.zip   build/linux-amd64/kaf-mcp
          zip -j kaf-mcp_${{ env.VERSION }}_linux_arm64.zip   build/linux-arm64/kaf-mcp
          zip -j kaf-mcp_${{ env.VERSION }}_linux_loong64.zip build/linux-loong64/kaf-mcp
          zip -j kaf-mcp_${{ env.VERSION }}_wasm_wasip1.zip   build/wasm-wasip1/kaf-mcp.wasm README_wasi.md

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ./kaf-cli_*.zip
            ./kaf-mcp_*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: "!startsWith(github.ref, 'refs/tags/')"
        with:
          name: kaf-build-${{ env.VERSION }}
          path: |
            ./kaf-cli_*.zip
            ./kaf-mcp_*.zip
          retention-days: 7
